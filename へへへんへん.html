<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>発車ベル & 戸締め放送プレイヤー (オフライン対応)</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
h1 { text-align: center; }
.button { display: block; width: 90%; margin: 10px auto; padding: 15px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer; }
.file-input { display: block; margin: 10px auto; }
.play { background-color: #4CAF50; color: white; }
.stop { background-color: #f44336; color: white; }
.serial { background-color: #2196F3; color: white; }
#status { text-align: center; margin: 10px; font-size: 1.2em; font-weight: bold; color: #333; }
#countdown { text-align: center; margin: 10px; font-size: 1.1em; color: #555; }
.checkbox-label { display:block; text-align:center; margin:10px; font-size:1.1em; }
.volume-control { width: 80%; margin: 0 auto; display: flex; align-items: center; justify-content: center; gap: 10px; }
</style>
</head>
<body>
<h1>発車ベル & 戸締め放送プレイヤー (オフライン対応)</h1>

<label>発車ベル選択</label>
<input type="file" id="bellFile" accept="audio/*" class="file-input">
<div class="volume-control">
  <label>音量:</label>
  <input type="range" id="bellVolume" min="0" max="1" step="0.01" value="1">
</div>

<label>戸締め放送選択</label>
<input type="file" id="closingFile" accept="audio/*" class="file-input">
<div class="volume-control">
  <label>音量:</label>
  <input type="range" id="closingVolume" min="0" max="1" step="0.01" value="1">
</div>

<label class="checkbox-label">
  <input type="checkbox" id="closingEnabled" checked> 戸締め放送を再生する
</label>

<button id="playBtn" class="button play">再生</button>
<button id="stopBtn" class="button stop">停止</button>
<button id="serialBtn" class="button serial">シリアル接続</button>

<div id="status">ステータス: 停止中</div>
<div id="countdown"></div>

<script>
let bellAudio = new Audio();
let closingAudio = new Audio();
let serialPort = null;
let reader = null;
let keepLooping = false; // 発車ベルループフラグ
const statusDiv = document.getElementById('status');
const countdownDiv = document.getElementById('countdown');
const closingCheckbox = document.getElementById('closingEnabled');
let countdownTimer = null;

// IndexedDB 用
let db;
const dbRequest = indexedDB.open('bellDB', 1);
dbRequest.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore('files', { keyPath: 'name' });
};
dbRequest.onsuccess = e => { db = e.target.result; };
dbRequest.onerror = e => { console.error('DBエラー', e); };

async function saveFileToDB(name, file) {
    return new Promise(resolve => {
        const tx = db.transaction('files', 'readwrite');
        tx.objectStore('files').put({name, file});
        tx.oncomplete = () => resolve();
    });
}

async function loadFileFromDB(name) {
    return new Promise(resolve => {
        const tx = db.transaction('files', 'readonly');
        const req = tx.objectStore('files').get(name);
        req.onsuccess = () => resolve(req.result ? req.result.file : null);
    });
}

// ファイル選択イベント
document.getElementById('bellFile').addEventListener('change', async e => {
    const file = e.target.files[0];
    if(file) {
        bellAudio.src = URL.createObjectURL(file);
        await saveFileToDB('bell', file);
    }
});
document.getElementById('closingFile').addEventListener('change', async e => {
    const file = e.target.files[0];
    if(file) {
        closingAudio.src = URL.createObjectURL(file);
        await saveFileToDB('closing', file);
    }
});

// 音量スライダー
document.getElementById('bellVolume').addEventListener('input', e => {
    bellAudio.volume = e.target.value;
});
document.getElementById('closingVolume').addEventListener('input', e => {
    closingAudio.volume = e.target.value;
});

// オフライン用ロード
async function loadAudioFiles() {
    if(!bellAudio.src) {
        const bellFile = await loadFileFromDB('bell');
        if(bellFile) bellAudio.src = URL.createObjectURL(bellFile);
    }
    if(!closingAudio.src) {
        const closingFile = await loadFileFromDB('closing');
        if(closingFile) closingAudio.src = URL.createObjectURL(closingFile);
    }
}

// カウントダウン
function startCountdown(audio, label) {
    clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
        let remaining = Math.max(0, Math.ceil(audio.duration - audio.currentTime));
        countdownDiv.textContent = `${label} 残り: ${remaining}s`;
        if(audio.paused) clearInterval(countdownTimer);
    }, 200);
}

// 発車ベルループ再生
async function playBell() {
    await loadAudioFiles();
    if(!bellAudio.src) return;
    bellAudio.currentTime = 0;
    statusDiv.textContent = 'ステータス: 発車ベル再生中';
    await bellAudio.play();
    startCountdown(bellAudio, '発車ベル');

    bellAudio.onended = () => {
        if (keepLooping) playBell();
    };
}

// 戸締め放送再生
async function playClosing() {
    await loadAudioFiles();
    if(closingCheckbox.checked && closingAudio.src) {
        closingAudio.currentTime = 0;
        statusDiv.textContent = 'ステータス: 戸締め放送再生中';
        await closingAudio.play();
        startCountdown(closingAudio, '戸締め放送');
        closingAudio.onended = () => {
            statusDiv.textContent = 'ステータス: 停止中';
            countdownDiv.textContent='';
        };
    } else {
        statusDiv.textContent = 'ステータス: 停止中';
        countdownDiv.textContent='';
    }
}

// 再生開始
async function playSequence() {
    keepLooping = true;
    playBell();
}

// 停止
async function stopSequence() {
    keepLooping = false;
    bellAudio.pause();
    bellAudio.currentTime = 0;
    clearInterval(countdownTimer);
    await playClosing();
}

// 手動ボタン
document.getElementById('playBtn').addEventListener('click', playSequence);
document.getElementById('stopBtn').addEventListener('click', stopSequence);

// シリアル接続
document.getElementById('serialBtn').addEventListener('click', async () => {
    try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 9600 });
        reader = serialPort.readable.getReader();
        readSerialLoop();
        alert('シリアル接続完了');
    } catch(e) { console.error(e); alert('接続に失敗しました'); }
});

// シリアル読み取りループ
async function readSerialLoop() {
    try {
        while(true) {
            const { value, done } = await reader.read();
            if(done) break;
            if(value && value.length > 0) {
                if(value[0] === 0) { // ON
                    playSequence();
                } else if(value[0] === 1) { // OFF
                    stopSequence();
                }
            }
        }
    } catch(e){ console.error(e); }
}

// ---------------------------
// PWA Service Worker
if ('serviceWorker' in navigator) {
    const swBlob = new Blob([`
        const cacheName = 'bell-app-v5';
        const filesToCache = ['./','./index.html'];
        self.addEventListener('install', e => {
            e.waitUntil(caches.open(cacheName).then(c => c.addAll(filesToCache)));
        });
        self.addEventListener('fetch', e => {
            e.respondWith(
                caches.match(e.request).then(r => r || fetch(e.request))
                .catch(() => e.request.mode==='navigate' ? caches.match('./index.html') : undefined)
            );
        });
        self.addEventListener('activate', e => {
            e.waitUntil(
                caches.keys().then(keys => Promise.all(keys.map(k => {
                    if(k !== cacheName) return caches.delete(k);
                })))
            );
        });
    `], { type: 'application/javascript' });

    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(console.error);
}

// ホーム画面追加
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.createElement('button');
    installBtn.textContent = 'ホーム画面に追加';
    installBtn.className = 'button serial';
    installBtn.onclick = async () => {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
    };
    document.body.appendChild(installBtn);
});
</script>
</body>
</html>

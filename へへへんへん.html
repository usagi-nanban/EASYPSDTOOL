<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>発車ベル & 戸締め放送プレイヤー (オフライン対応)</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
h1 { text-align: center; }
.button { display: block; width: 90%; margin: 10px auto; padding: 15px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer; }
.file-input { display: block; margin: 10px auto; }
.play { background-color: #4CAF50; color: white; }
.stop { background-color: #f44336; color: white; }
.serial { background-color: #2196F3; color: white; }
#status { text-align: center; margin: 10px; font-size: 1.2em; font-weight: bold; color: #333; }
#countdown { text-align: center; margin: 10px; font-size: 1.1em; color: #555; }
.checkbox-label { display:block; text-align:center; margin:10px; font-size:1.1em; }
.volume-control { width: 90%; margin: 10px auto; display: flex; align-items: center; }
.volume-control label { flex: 1; }
.volume-control input[type=range] { flex: 3; }
</style>
</head>
<body>
<h1>発車ベル & 戸締め放送プレイヤー (オフライン対応)</h1>

<label>発車ベル選択</label>
<input type="file" id="bellFile" accept="audio/*" class="file-input">

<!-- 追加: 発車ベル音量調整 -->
<div class="volume-control">
  <label for="bellVolume">発車ベル音量</label>
  <input type="range" id="bellVolume" min="0" max="1" step="0.01" value="1">
</div>

<label>戸締め放送選択</label>
<input type="file" id="closingFile" accept="audio/*" class="file-input">

<!-- 追加: 戸締め放送音量調整 -->
<div class="volume-control">
  <label for="closingVolume">戸締め放送音量</label>
  <input type="range" id="closingVolume" min="0" max="1" step="0.01" value="1">
</div>

<label class="checkbox-label">
  <input type="checkbox" id="closingEnabled" checked> 戸締め放送を再生する
</label>

<button id="playBtn" class="button play">再生</button>
<button id="stopBtn" class="button stop">停止</button>
<button id="serialBtn" class="button serial">シリアル接続</button>

<div id="status">ステータス: 停止中</div>
<div id="countdown"></div>

<script>
let bellAudio = new Audio();
let closingAudio = new Audio();
let serialPort = null;
let reader = null;
const statusDiv = document.getElementById('status');
const countdownDiv = document.getElementById('countdown');
const closingCheckbox = document.getElementById('closingEnabled');
let countdownTimer = null;

// 音量スライダーのイベント設定
document.getElementById('bellVolume').addEventListener('input', e => {
    bellAudio.volume = parseFloat(e.target.value);
});
document.getElementById('closingVolume').addEventListener('input', e => {
    closingAudio.volume = parseFloat(e.target.value);
});

// IndexedDB 用
let db;
const dbRequest = indexedDB.open('bellDB', 1);
dbRequest.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore('files', { keyPath: 'name' });
};
dbRequest.onsuccess = e => { db = e.target.result; };
dbRequest.onerror = e => { console.error('DBエラー', e); };

async function saveFileToDB(name, file) {
    return new Promise(resolve => {
        const tx = db.transaction('files', 'readwrite');
        const store = tx.objectStore('files');
        store.put({name, file});
        tx.oncomplete = () => resolve();
    });
}

async function loadFileFromDB(name) {
    return new Promise(resolve => {
        const tx = db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const req = store.get(name);
        req.onsuccess = () => resolve(req.result ? req.result.file : null);
    });
}

// ファイル選択イベント
document.getElementById('bellFile').addEventListener('change', async e => {
    const file = e.target.files[0];
    if(file) {
        bellAudio.src = URL.createObjectURL(file);
        await saveFileToDB('bell', file);
    }
});
document.getElementById('closingFile').addEventListener('change', async e => {
    const file = e.target.files[0];
    if(file) {
        closingAudio.src = URL.createObjectURL(file);
        await saveFileToDB('closing', file);
    }
});

// オフライン用ロード
async function loadAudioFiles() {
    if(!bellAudio.src) {
        const bellFile = await loadFileFromDB('bell');
        if(bellFile) bellAudio.src = URL.createObjectURL(bellFile);
    }
    if(!closingAudio.src) {
        const closingFile = await loadFileFromDB('closing');
        if(closingFile) closingAudio.src = URL.createObjectURL(closingFile);
    }
}

// カウントダウン
function startCountdown(audio, label) {
    clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
        let remaining = Math.max(0, Math.ceil(audio.duration - audio.currentTime));
        countdownDiv.textContent = `${label} 残り: ${remaining}s`;
        if(audio.paused) clearInterval(countdownTimer);
    }, 200);
}

// 発車ベル再生
async function playBell() {
    await loadAudioFiles();
    if(!bellAudio.src) return;
    bellAudio.currentTime = 0;
    statusDiv.textContent = 'ステータス: 発車ベル再生中';
    await bellAudio.play();
    startCountdown(bellAudio, '発車ベル');
}

// 戸締め放送再生
async function playClosing() {
    await loadAudioFiles();
    if(closingCheckbox.checked && closingAudio.src) {
        closingAudio.pause();
        closingAudio.currentTime = 0;
        statusDiv.textContent = 'ステータス: 戸締め放送再生中';
        await closingAudio.play();
        startCountdown(closingAudio, '戸締め放送');
        closingAudio.onended = () => {
            statusDiv.textContent = 'ステータス: 停止中';
            countdownDiv.textContent='';
        };
    } else {
        statusDiv.textContent = 'ステータス: 停止中';
        countdownDiv.textContent='';
    }
}

// 再生
async function playSequence() {
    await playBell();
    bellAudio.onended = playClosing;
}

// 停止（打ち返し）
async function stopSequence() {
    bellAudio.pause();
    bellAudio.currentTime = 0;
    clearInterval(countdownTimer);
    await playClosing();
}

document.getElementById('playBtn').addEventListener('click', playSequence);
document.getElementById('stopBtn').addEventListener('click', stopSequence);

// ---------------------------
// シリアル接続
document.getElementById('serialBtn').addEventListener('click', async () => {
    try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 9600 });
        reader = serialPort.readable.getReader();
        readSerialLoop();
        alert('シリアル接続完了');
    } catch(e) { console.error(e); alert('接続に失敗しました'); }
});

async function readSerialLoop() {
    try {
        while(true) {
            const { value, done } = await reader.read();
            if(done) break;
            if(value && value.length > 0) {
                if(value[0] === 0) { // TTL LOWで発車ベル→戸締め
                    playSequence();
                }
            }
        }
    } catch(e){ console.error(e); }
}

// ---------------------------
// PWA Service Worker
if ('serviceWorker' in navigator) {
    const swBlob = new Blob([`
        const cacheName = 'bell-app-v4';
        const filesToCache = ['./','./index.html'];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(cacheName).then(cache => cache.addAll(filesToCache))
            );
        });

        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request).then(response => {
                    return response || fetch(event.request);
                }).catch(() => {
                    if (event.request.mode === 'navigate') {
                        return caches.match('./index.html');
                    }
                })
            );
        });

        self.addEventListener('activate', event => {
            event.waitUntil(
                caches.keys().then(keys =>
                    Promise.all(keys.map(key => {
                        if (key !== cacheName) return caches.delete(key);
                    }))
                )
            );
        });
    `], { type: 'application/javascript' });

    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(console.error);
}

// ホーム画面追加
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.createElement('button');
    installBtn.textContent = 'ホーム画面に追加';
    installBtn.className = 'button serial';
    installBtn.onclick = async () => {
        deferredPrompt.prompt();
        const choiceResult = await deferredPrompt.userChoice;
        console.log(choiceResult.outcome);
        deferredPrompt = null;
    };
    document.body.appendChild(installBtn);
});
</script>
</body>
</html>
